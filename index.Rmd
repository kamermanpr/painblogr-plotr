---
title: "plotr"
output: 
  flexdashboard::flex_dashboard:
    navbar:
    social: ['menu']
    source_code: 'https://github.com/kamermanpr/painblogr-plotr.git'
runtime: shiny
---

```{r setup, include = FALSE}
library(flexdashboard)
library(shiny)
library(rlang)
library(readr)
library(dplyr)
library(tidyr)
library(skimr)
library(ggplot2)
library(ggthemes)

# skimr variables
my_skim <- skim_with(base = sfl(Missing = n_missing,
                                Complete = n_complete),
                     numeric = sfl(mean = NULL, sd = NULL,
                                   p0 = NULL, p25 = NULL, p50 = NULL, 
                                   p75 = NULL, p100 = NULL, hist = NULL,
                                   Mean = ~ mean(., na.rm = TRUE),
                                   SD = ~ sd(., na.rm = TRUE),
                                   Min = ~ min(., na.rm = TRUE),
                                   Q1 = ~ quantile(., probs = 0.25, na.rm = TRUE),
                                   Median = ~ quantile(., probs = 0.5, na.rm = TRUE),
                                   Q3 = ~ quantile(., probs = 0.75, na.rm = TRUE),
                                   Max = ~max(., na.rm = TRUE)),
                     factor = sfl(ordered = NULL,
                                  top_counts = NULL,
                                  `Top 3 levels` = ~ top_counts(., 
                                                                max_char = 15,
                                                                max_levels = 3)))
```

```{r eval = FALSE}
# Packages
library(stringr)
library(palmerpenguins)

# Datasets
## Long format
### Iris
iris %>% 
    write_csv(file = 'data/iris_original.csv')

iris %>% 
    group_by(Species) %>% 
    slice_head(n = 5) %>% 
    ungroup() %>% 
    select(Species, everything()) %>% 
    write_csv(file = 'data/iris_reduced.csv')

### Penguins
penguins %>% 
    write_csv(file = 'data/penguins_orginal.csv')

penguins %>% 
    filter(complete.cases(.)) %>% 
    group_by(species, island) %>% 
    slice_head(n = 3) %>% 
    ungroup() %>% 
    select(-year) %>% 
    select(species, everything()) %>% 
    write_csv(file = 'data/penguins_sample.csv')
```

Welcome {data-nav='Welcome'}
===================================== 

<!--- <a href='https://www.wits.ac.za' target='_blank'>
<img src='wits-logo.png' 
alt='Wits give you the edge' 
width='25%'>
</a> --->

**Welcome**  

The app provides basic plot options, such as box-and-whisker plots, scatter plots, bar charts, and histograms. 

To analyse your data, please use the companion app, [`statr`](https://kamermanpr.shinyapps.io/painblogr-statr/){ target='_blank' }

**Steps to plotting your data**  

- Go to the _"Upload data"_ page, upload your data and choose the variables according to whether they are numeric values or categorical values

- Once the data have been uploaded and variables selected, choose the type of plot you want from the drop-down menu labelled _“Select a plot type”_.

- Select the variables to plot (the plot will be auto-generated).

- Play with the settings to fine-tune the appearance of the plot.

- Download the plot.

**Data format**  

Only CSV files can be uploaded, and the data must be "tidy". By "tidy", we mean that the data must be arranged in "long" format such that:

- Each row contains data from an observation.

- Each column contains only one variable.

- Each value must have its own cell

<div>
<img src='tidy-data.png' width='60%'>
</div>

For a full description of tidy data, please use the following [link](https://www.jstatsoft.org/article/view/v059i10){ target='_blank' }.

To download a dataset to play around with on the app, we recommend [Allison Horst's](https://allisonhorst.github.io/palmerpenguins/index.html){ target='_blank' } "Palmer Penguins" dataset ([link to data](https://drive.google.com/open?id=1-8H1Mz2_oEMu3zlVsatraFruJQlCFqZ9&authuser=peter.kamerman%40gmail.com&usp=drive_fs){ target='_blank' })

**Developers**  

The app was developed by Peter Kamerman (WWW: [painblogr.org](https://www.painblogr.org){ target='_blank'}, GitHub: [kamermanpr](https://github.com/kamermanpr){ target='_blank' }) and Kavilan Nair (GitHub: [TripleBlackCat](https://github.com/TripleBlackCat){ target='_blank' }).

The development of the app was inspired by the [BoxPlotR](http://shiny.chemgrid.org/boxplotr/){ target='_blank' } app. 

**License**  

The software is released under an [MIT license](https://github.com/kamermanpr/painblogr-plotr/blob/main/LICENSE){ target='_blank' }.

**Issues**

To report any issues you have with the app, please use the following [link](https://github.com/kamermanpr/painblogr-plotr/issues){ target='_blank' }.

**Software citations**

- R Core Team (2021). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL: [https://www.R-project.org/](https://www.R-project.org/){ target='_blank'}.

- Jeffrey B. Arnold (2021). ggthemes: Extra Themes, Scales and Geoms for 'ggplot2'. R package version 4.2.4. URL: [https://CRAN.R-project.org/package=ggthemes](https://CRAN.R-project.org/package=ggthemes){ target='_blank'}.
  
- Winston Chang, Joe Cheng, JJ Allaire, Carson Sievert, Barret Schloerke, Yihui Xie, Jeff Allen, Jonathan McPherson, Alan Dipert and Barbara Borges (2021). shiny: Web Application Framework for R. R package version 1.7.1. URL: [https://CRAN.R-project.org/package=shiny](https://CRAN.R-project.org/package=shiny){ target='_blank'}.
  
- Lionel Henry and Hadley Wickham (2021). rlang: Functions for Base Types and Core R and 'Tidyverse' Features. R package version 0.4.12. URL: [https://CRAN.R-project.org/package=rlang](https://CRAN.R-project.org/package=rlang){ target='_blank'}.

- Richard Iannone, JJ Allaire and Barbara Borges (2020). flexdashboard: R Markdown Format for Flexible Dashboards. R package version 0.5.2. URL: [https://CRAN.R-project.org/package=flexdashboard](https://CRAN.R-project.org/package=flexdashboard){ target='_blank'}.

- Elin Waring, Michael Quinn, Amelia McNamara, Eduardo Arino de la Rubia, Hao Zhu and Shannon Ellis (2021). skimr: Compact and Flexible Summaries of Data. R package version 2.1.3. URL: [https://CRAN.R-project.org/package=skimr](https://CRAN.R-project.org/package=skimr){ target='_blank'}.

- Hadley Wickham, Romain François, Lionel Henry and Kirill Müller (2021). dplyr: A Grammar of Data Manipulation. R package version 1.0.7. URL: [https://CRAN.R-project.org/package=dplyr](https://CRAN.R-project.org/package=dplyr){ target='_blank'}.

- Hadley Wickham, Jim Hester and Jennifer Bryan (2021). readr: Read Rectangular Text Data. R package version 2.1.1. URL: [https://CRAN.R-project.org/package=readr](https://CRAN.R-project.org/package=readr){ target='_blank'}.

- Hadley Wickham (2021). tidyr: Tidy Messy Data. R package version 1.1.4. URL: [https://CRAN.R-project.org/package=tidyr](https://CRAN.R-project.org/package=tidyr){ target='_blank'}.

- Hadley Wickham (2016). ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag, New York.

Upload data {data-nav='Upload data'}
=====================================

Column {.sidebar data-width=350}
-------------------------------------

```{r upload_1}
h1('Upload data')

p('Once the data have been uploaded, choose all variables that should be treated as numeric variables, and all variables that should be treated as categorical variables.')

hr()

# Upload file
fileInput(inputId = 'file0', 
          label = 'Import data (csv format)',
          multiple = FALSE,
          accept = c('.csv'))

# Make reactive data
df <- reactive({
    req(input$file0)
    read_csv(input$file0$datapath, 
             show_col_types = FALSE)
})

# Choose numeric columns
output$data_numeric <- renderUI({
    varSelectizeInput(inputId = 'numeric',
                   label = 'Select numeric variables',
                   multiple = TRUE,
                   data = df())
})

uiOutput('data_numeric')

# Choose categorical columns
output$data_categorical <- renderUI({
    varSelectizeInput(inputId = 'categorical',
                   label = 'Select categorical variables',
                   multiple = TRUE,
                   data = df())
})

uiOutput('data_categorical')

```

Row 
-------------------------------------

### Table 1: Summary of numeric variables

```{r upload_2}
df_numeric <- reactive({
    req(df())
    df() %>% 
        select(!!!input$numeric) %>% 
        mutate(across(.cols = everything(), ~ as.numeric(.x)))
})

output$tbl_numeric <- renderTable(
    if(ncol(df_numeric()) != 0){
        df_numeric() %>% 
            my_skim() %>% 
            yank('numeric') %>% 
            rename(Variable = skim_variable)
    }
)

tableOutput('tbl_numeric')
```

### Table 2: Summary of categorical variables

```{r upload_3}
df_categorical <- reactive({
    req(df())
    df() %>% 
        select(!!!input$categorical) %>% 
        mutate(across(.cols = everything(), ~ as.factor(.x)))
})

output$tbl_categorical <- renderTable(
    if(ncol(df_categorical()) != 0){
        df_categorical() %>% 
            my_skim() %>% 
            yank('factor') %>% 
            rename(Variable = skim_variable,
                   `Unique levels` = n_unique)
    }
)

tableOutput('tbl_categorical')
```

```{r upload_4}
# Generate combined data file
df_combined <- reactive({
    bind_cols(df_numeric(), df_categorical())
    })
```

Boxplot {data-navmenu='Select a plot type'}
=====================================  

Column {.sidebar data-width=350}
-------------------------------------

```{r boxplot_1}
h1('Boxplot')

p(strong('Remember to upload your data first.'))

p('The default setting is to display plots with only one grouping variable using a black-and-white colour palette. If you wish to add colour to these plots, select the second grouping variable as the same as the first grouping variable.')

p('Beeswarm points are "jittered" horizontally only. That is, the value of each point, as measured on the y-axis, remains unchanged.')

p('For plot download options, scroll to the bottom of this sidebar.')

hr()

# Select variables
## Response variable
output$box_yvar <- renderUI({
    req(df_numeric())
    varSelectInput(inputId = 'box_y_var',
                   label = 'Choose response variable',
                   selected = NULL,
                   data = df_numeric())
    })

uiOutput('box_yvar')

## Grouping variable
output$box_groupvar <- renderUI({
    req(df_categorical())
    selectInput(inputId = 'box_group_var',
                label = 'Choose grouping variable',
                selected = 'None',
                choices = c('None', names(df_categorical())))
    })

uiOutput('box_groupvar')

## Second grouping variable
output$box_groupvar2 <- renderUI({
    req(df_categorical)
    selectInput(inputId = 'box_group2_var',
                label = 'Choose second grouping variable (optional)',
                selected = 'None',
                choices = c('None', names(df_categorical())))
    })

uiOutput('box_groupvar2')

## Choose plot type
radioButtons(inputId = 'box_plot_type',
             label = 'Plot type',
             choices = c('Simple boxplot (default)' = 'box',
                         'Add beeswarm' = 'box_points'),
             selected = 'box')

## Add labels
textInput(inputId = 'box_title', 
          label = 'Plot title',
          value = NULL)

textInput(inputId = 'box_y_label', 
          label = 'Y-axis label',
          value = NULL)

textInput(inputId = 'box_x_label', 
          label = 'X-axis label',
          value = NULL)

## Base font size
sliderInput(inputId = 'box_base_size',
            label = 'Font size',
            value = 18,
            min = 8,
            max = 28)

## Y-axis limits
numericInput(inputId = 'box_min_y',
             label = 'Minimum y-axis value',
             value = NULL)

numericInput(inputId = 'box_max_y',
             label = 'Maximum y-axis value',
             value = NULL)

## Point size size
sliderInput(inputId = 'box_size',
            label = 'Point size (beeswarm points)',
            value = 3,
            min = 0,
            max = 10)

## Point transparency size
sliderInput(inputId = 'box_alpha',
            label = 'Point transparency (beeswarm points)',
            value = 1,
            min = 0,
            max = 1)

## Point scatter width
sliderInput(inputId = 'box_scatter_width',
            label = 'Scatter width (beeswarm points)',
            value = 0.3,
            min = 0,
            max = 1)

hr()

strong('Options for the second grouping variable')

## Colour scheme
selectInput(inputId = 'box_colours',
            label = 'Colour scheme',
            selected = NULL,
            choices = c('Default (20 colours)' = 'Tableau 20',
                        'Tableau (10 colours)' = 'Tableau 10',
                        'Colour blind (10 colours)' = 'Color Blind',
                        'Grey (5 colours)' = 'Classic Gray 5'))

## Legend position
radioButtons(inputId = 'box_legend_position',
             label = 'Legend position',
             choices =c ('None (default)'= 'none',
                         'Right side of plot' = 'right',
                         'Above the plot' = 'top',
                         'User-defined' = 'legend_user'),
             selected = 'none')

### x value
sliderInput(inputId = 'box_x_legend',
            label = 'User-defined legend position (x coordinate)',
            value = 0.85,
            min = 0,
            max = 1)

### y-value
sliderInput(inputId = 'box_y_legend',
            label = 'User-defined legend position (y coordinate)',
            value = 0.85,
            min = 0,
            max = 1)

hr()

h1('Download plot')

# Format
selectInput(inputId = 'box_format',
            label = 'Choose file format',
            selected = 'png',
            choices = c('bmp', 'jpg', 'pdf', 'png'))

# Plot width
numericInput(inputId = 'box_width',
             label = 'Figure width (cm)',
             value = 17)

## Plot height
numericInput(inputId = 'box_height',
             label = 'Figure height (cm)',
             value = 14)

# Add download button
output$box_download_button <- renderUI({
    downloadButton(outputId = 'boxplot_download_button',
                   label = "'Click' to download image")
    })

uiOutput('box_download_button')
```

Column
-------------------------------------

### Plot

```{r boxplot_2}
# Plot graph
output$box_plot <- renderPlot(
    
    if(req(input$box_plot_type) == 'box' & req(input$box_group_var) == 'None'){
        
        df_combined() %>%
                ggplot(data = .) +
                aes(x = '',
                    y = !!input$box_y_var) +
                geom_boxplot() +
                labs(title = input$box_title,
                     y = input$box_y_label,
                     x = input$box_x_label) +
                scale_y_continuous(limits = c(input$box_min_y, input$box_max_y)) +
                scale_x_discrete(na.translate = FALSE) +
                theme_minimal(base_size = input$box_base_size) +
                theme(legend.position = 'none',
                          plot.background = element_rect(colour = '#FFFFFF',
                                                         fill = '#FFFFFF'),
                          plot.title = element_text(size = input$box_base_size),
                          axis.text = element_text(colour = '#000000'),
                          axis.line = element_line(colour = '#000000',
                                                   size = 0.5),
                          axis.ticks = element_line(colour = '#000000',
                                                    size = 0.5),
                          panel.grid = element_blank()) 
        
        
    } else if(req(input$box_plot_type) == 'box' & req(input$box_group_var) != 'None'){
        
        if(req(input$box_group2_var) == 'None'){
            
            df_combined() %>%
                ggplot(data = .) +
                aes(x = df_combined()[[input$box_group_var]],
                    y = !!input$box_y_var) +
                geom_boxplot() +
                labs(title = input$box_title,
                     y = input$box_y_label,
                     x = input$box_x_label) +
                scale_y_continuous(limits = c(input$box_min_y, input$box_max_y)) +
                scale_x_discrete(na.translate = FALSE) +
                theme_minimal(base_size = input$box_base_size) +
                theme(legend.position = 'none',
                          plot.background = element_rect(colour = '#FFFFFF',
                                                         fill = '#FFFFFF'),
                          plot.title = element_text(size = input$box_base_size),
                          axis.text = element_text(colour = '#000000'),
                          axis.line = element_line(colour = '#000000',
                                                   size = 0.5),
                          axis.ticks = element_line(colour = '#000000',
                                                    size = 0.5),
                          panel.grid = element_blank()) 
            
        } else {
            
            if(input$box_legend_position != 'legend_user'){
                
                df_combined() %>% 
                    ggplot(data = .) +
                    aes(x = df_combined()[[input$box_group_var]],
                        y = !!input$box_y_var,
                        fill = df_combined()[[!!input$box_group2_var]],
                        colour = df_combined()[[!!input$box_group2_var]]) +
                    geom_boxplot(alpha = 0.6) +
                    labs(title = input$box_title,
                         y = input$box_y_label,
                         x = input$box_x_label) +
                    scale_y_continuous(limits = c(input$box_min_y, input$box_max_y)) +
                    scale_x_discrete(na.translate = FALSE) +
                    scale_fill_tableau(palette = input$box_colours,
                                       na.translate = FALSE) +
                    scale_colour_tableau(palette = input$box_colours,
                                         na.translate = FALSE) +
                    theme_minimal(base_size = input$box_base_size) +
                    theme(legend.position = input$box_legend_position,
                          legend.title = element_blank(),
                          plot.background = element_rect(colour = '#FFFFFF',
                                                         fill = '#FFFFFF'),
                          plot.title = element_text(size = input$box_base_size),
                          axis.text = element_text(colour = '#000000'),
                          axis.line = element_line(colour = '#000000',
                                                   size = 0.5),
                          axis.ticks = element_line(colour = '#000000',
                                                    size = 0.5),
                          panel.grid = element_blank()) 
                
                } else if(input$box_legend_position == 'legend_user'){
                    
                    df_combined() %>% 
                        ggplot(data = .) +
                        aes(x = df_combined()[[input$box_group_var]],
                            y = !!input$box_y_var,
                            fill = df_combined()[[!!input$box_group2_var]],
                            colour = df_combined()[[!!input$box_group2_var]]) +
                        geom_boxplot(alpha = 0.6) +
                        labs(title = input$box_title,
                             y = input$box_y_label,
                             x = input$box_x_label) +
                        scale_y_continuous(limits = c(input$box_min_y, input$box_max_y)) +
                        scale_x_discrete(na.translate = FALSE) +
                        scale_fill_tableau(palette = input$box_colours,
                                           na.translate = FALSE) +
                        scale_colour_tableau(palette = input$box_colours,
                                             na.translate = FALSE) +
                        theme_minimal(base_size = input$box_base_size) +
                        theme(legend.position = c(input$box_x_legend, input$box_y_legend),
                              legend.title = element_blank(),
                              plot.background = element_rect(colour = '#FFFFFF',
                                                             fill = '#FFFFFF'),
                              plot.title = element_text(size = input$box_base_size),
                              axis.text = element_text(colour = '#000000'),
                              axis.line = element_line(colour = '#000000',
                                                       size = 0.5),
                              axis.ticks = element_line(colour = '#000000',
                                                        size = 0.5),
                              panel.grid = element_blank()) 
                    
                }
            }
        
        } else if(input$box_plot_type == 'box_points' & input$box_group_var == 'None'){
            
            df_combined() %>%
                ggplot(data = .) +
                aes(x = '',
                    y = !!input$box_y_var) +
                geom_boxplot(outlier.shape = NA) +
                geom_point(position = position_jitter(seed = 1234,
                                                      width = input$box_scatter_width,
                                                      height = 0),
                           fill = '#000000',
                           alpha = input$box_alpha,
                           shape = 21,
                           size = input$box_size) +
                geom_point(position = position_jitter(seed = 1234,
                                                      width = input$box_scatter_width,
                                                      height = 0),
                           shape = 21,
                           size = input$box_size) +
                labs(title = input$box_title,
                     y = input$box_y_label,
                     x = input$box_x_label) +
                scale_y_continuous(limits = c(input$box_min_y, input$box_max_y)) +
                scale_x_discrete(na.translate = FALSE) +
                theme_minimal(base_size = input$box_base_size) +
                theme(legend.position = 'none',
                          plot.background = element_rect(colour = '#FFFFFF',
                                                         fill = '#FFFFFF'),
                          plot.title = element_text(size = input$box_base_size),
                          axis.text = element_text(colour = '#000000'),
                          axis.line = element_line(colour = '#000000',
                                                   size = 0.5),
                          axis.ticks = element_line(colour = '#000000',
                                                    size = 0.5),
                          panel.grid = element_blank()) 
            
        } else if(input$box_plot_type == 'box_points' & input$box_group_var != 'None'){
            
            if(req(input$box_group2_var) == 'None'){
            
            df_combined() %>%
                ggplot(data = .) +
                aes(x = df_combined()[[input$box_group_var]],
                    y = !!input$box_y_var) +
                geom_boxplot(outlier.shape = NA) +
                geom_point(position = position_jitter(seed = 1234,
                                                      width = input$box_scatter_width,
                                                      height = 0),
                           fill = '#000000',
                           alpha = input$box_alpha,
                           shape = 21,
                           size = input$box_size) +
                geom_point(position = position_jitter(seed = 1234,
                                                      width = input$box_scatter_width,
                                                      height = 0),
                           shape = 21,
                           size = input$box_size) +
                labs(title = input$box_title,
                     y = input$box_y_label,
                     x = input$box_x_label) +
                scale_y_continuous(limits = c(input$box_min_y, input$box_max_y)) +
                scale_x_discrete(na.translate = FALSE) +
                theme_minimal(base_size = input$box_base_size) +
                theme(legend.position = 'none',
                          plot.background = element_rect(colour = '#FFFFFF',
                                                         fill = '#FFFFFF'),
                          plot.title = element_text(size = input$box_base_size),
                          axis.text = element_text(colour = '#000000'),
                          axis.line = element_line(colour = '#000000',
                                                   size = 0.5),
                          axis.ticks = element_line(colour = '#000000',
                                                    size = 0.5),
                          panel.grid = element_blank()) 
            
        } else {
            
            if(input$box_legend_position != 'legend_user'){
                
                df_combined() %>% 
                    ggplot(data = .) +
                    aes(x = df_combined()[[input$box_group_var]],
                        y = !!input$box_y_var,
                        fill = df_combined()[[!!input$box_group2_var]],
                        colour = df_combined()[[!!input$box_group2_var]]) +
                    geom_boxplot(outlier.shape = NA,
                                 alpha = 0.6) +
                    geom_point(position = position_jitterdodge(seed = 1234,
                                                          jitter.width = input$box_scatter_width,
                                                          jitter.height = 0),
                               alpha = input$box_alpha,
                               shape = 21,
                               size = input$box_size) +
                    geom_point(position = position_jitterdodge(seed = 1234,
                                                          jitter.width = input$box_scatter_width,
                                                          jitter.height = 0),
                               fill = NA,
                               shape = 21,
                               size = input$box_size) +
                    labs(title = input$box_title,
                         y = input$box_y_label,
                         x = input$box_x_label) +
                    scale_y_continuous(limits = c(input$box_min_y, input$box_max_y)) +
                    scale_x_discrete(na.translate = FALSE) +
                    scale_fill_tableau(palette = input$box_colours,
                                       na.translate = FALSE) +
                    scale_colour_tableau(palette = input$box_colours,
                                         na.translate = FALSE) +
                    theme_minimal(base_size = input$box_base_size) +
                    theme(legend.position = input$box_legend_position,
                          legend.title = element_blank(),
                          plot.background = element_rect(colour = '#FFFFFF',
                                                         fill = '#FFFFFF'),
                          plot.title = element_text(size = input$box_base_size),
                          axis.text = element_text(colour = '#000000'),
                          axis.line = element_line(colour = '#000000',
                                                   size = 0.5),
                          axis.ticks = element_line(colour = '#000000',
                                                    size = 0.5),
                          panel.grid = element_blank()) 
                
                } else if(input$box_legend_position == 'legend_user'){
                    
                    df_combined() %>% 
                        ggplot(data = .) +
                        aes(x = df_combined()[[input$box_group_var]],
                            y = !!input$box_y_var,
                            fill = df_combined()[[!!input$box_group2_var]],
                            colour = df_combined()[[!!input$box_group2_var]]) +
                        geom_boxplot(outlier.shape = NA,
                                     alpha = 0.6) +
                        geom_point(position = position_jitterdodge(seed = 1234,
                                                              jitter.width = input$box_scatter_width,
                                                              jitter.height = 0),
                                   alpha = input$box_alpha,
                                   shape = 21,
                                   size = input$box_size) +
                        geom_point(position = position_jitterdodge(seed = 1234,
                                                              jitter.width = input$box_scatter_width,
                                                              jitter.height = 0),
                                   shape = 21,
                                   fill = NA,
                                   size = input$box_size) +
                        labs(title = input$box_title,
                             y = input$box_y_label,
                             x = input$box_x_label) +
                        scale_y_continuous(limits = c(input$box_min_y, input$box_max_y)) +
                        scale_x_discrete(na.translate = FALSE) +
                        scale_fill_tableau(palette = input$box_colours,
                                           na.translate = FALSE) +
                        scale_colour_tableau(palette = input$box_colours,
                                             na.translate = FALSE) +
                        theme_minimal(base_size = input$box_base_size) +
                        theme(legend.position = c(input$box_x_legend, input$box_y_legend),
                              legend.title = element_blank(),
                              plot.background = element_rect(colour = '#FFFFFF',
                                                             fill = '#FFFFFF'),
                              plot.title = element_text(size = input$box_base_size),
                              axis.text = element_text(colour = '#000000'),
                              axis.line = element_line(colour = '#000000',
                                                       size = 0.5),
                              axis.ticks = element_line(colour = '#000000',
                                                        size = 0.5),
                              panel.grid = element_blank()) 
                    
                }
            }
        }
)

plotOutput('box_plot')
```

```{r boxplot_3}
# Download plot
output$boxplot_download_button <- downloadHandler(
    filename = function() {
        paste0('boxplot_', Sys.Date(), '.', input$box_format)
    },
    content = function(file) {
        plotOutput('box_plot')
        ggsave(file, 
               width = input$box_width, 
               height = input$box_height,
               units = 'cm')
    }
  )
```

Scatter plot {data-navmenu='Select a plot type'}
=====================================  

Column {.sidebar data-width=350}
-------------------------------------

```{r scatter_1}
h1('Scatter plot')

p(strong('Remember to upload your data first.'))

p('For download options, scroll to the bottom of this sidebar.')

hr()

# Select variables
## Y variable
output$scatter_yvar <- renderUI({
    req(df_numeric())
    varSelectInput(inputId = 'scatter_y_var',
                   label = 'Choose response variable (y-axis)',
                   selected = NULL,
                   data =  df_numeric())
    })

uiOutput('scatter_yvar')

## X variable
output$scatter_xvar <- renderUI({
    req(df_numeric())
    varSelectInput(inputId = 'scatter_x_var',
                   label = 'Choose response variable (x-axis)',
                   selected = NULL,
                   data =  df_numeric())
    })

uiOutput('scatter_xvar')

output$scatter_groupvar <- renderUI({
    req(df_categorical())
    selectInput(inputId = 'scatter_group_var',
                label = 'Choose grouping variable (optional)',
                selected = NULL,
                choices = c('None', names(df_categorical())))
})

uiOutput('scatter_groupvar')

## Add regression or loess curve
radioButtons(inputId = 'scatter_smooth',
             label = 'Add regression line',
             choices = c('None (default)' = 'none',
                         'Linear regression' = 'linear',
                         'LOESS curve' = 'loess'),
             selected = 'none')

## Add labels
textInput(inputId = 'scatter_title', 
          label = 'Plot title',
          value = '')

textInput(inputId = 'scatter_y_label', 
          label = 'Y-axis label',
          value = '')

textInput(inputId = 'scatter_x_label', 
          label = 'X-axis label',
          value = '')

## Base font size
sliderInput(inputId = 'scatter_base_size',
            label = 'Font size',
            value = 18,
            min = 8,
            max = 28)

## Point size size
sliderInput(inputId = 'scatter_size',
            label = 'Point size',
            value = 3,
            min = 0,
            max = 10)

## Point transparency size
sliderInput(inputId = 'scatter_alpha',
            label = 'Point transparency',
            value = 1,
            min = 0,
            max = 1)

## Y-axis limits
numericInput(inputId = 'scatter_min_y',
             label = 'Minimum y-axis value',
             value = NULL)

numericInput(inputId = 'scatter_max_y',
             label = 'Maximum y-axis value',
             value = NULL)

## X-axis limits
numericInput(inputId = 'scatter_min_x',
             label = 'Minimum x-axis value',
             value = NULL)

numericInput(inputId = 'scatter_max_x',
             label = 'Maximum x-axis value',
             value = NULL)

hr()

strong('Options for grouping variable')

## Colour scheme
selectInput(inputId = 'scatter_colours',
            label = 'Colour scheme',
            selected = NULL,
            choices = c('Default (20 colours)' = 'Tableau 20',
                        'Tableau (10 colours)' = 'Tableau 10',
                        'Colour blind (10 colours)' = 'Color Blind',
                        'Grey (5 colours)' = 'Classic Gray 5'))

## Legend position
radioButtons(inputId = 'scatter_legend_position',
             label = 'Legend position',
             choices =c ('None (default)'= 'none',
                         'Right side of plot' = 'right',
                         'Above the plot' = 'top',
                         'User-defined' = 'legend_user'),
             selected = 'none')

### x value
sliderInput(inputId = 'scatter_x_legend',
            label = 'User-defined legend position (x coordinate)',
            value = 0.85,
            min = 0,
            max = 1)

### y-value
sliderInput(inputId = 'scatter_y_legend',
            label = 'User-defined legend position (y coordinate)',
            value = 0.85,
            min = 0,
            max = 1)

hr()

h1('Download plot')

# Format
selectInput(inputId = 'scatter_format',
            label = 'Choose file format',
            selected = 'png',
            choices = c('bmp', 'jpg', 'pdf', 'png'))

# Plot width
numericInput(inputId = 'scatter_width',
             label = 'Figure width (cm)',
             value = 16)

## Plot height
numericInput(inputId = 'scatter_height',
             label = 'Figure height (cm)',
             value = 16)

# Add download button
output$scatter_download_button <- renderUI({
    downloadButton(outputId = 'scatterplot_download_button',
                   label = "'Click' to download image")
    })

uiOutput('scatter_download_button')
```

Column
-------------------------------------

### Plot

```{r scatter_2}
# Plot graph
output$scatter_plot <- renderPlot(
    
    if(req(input$scatter_smooth) == 'none' & req(input$scatter_group_var) == 'None'){
        
        ggplot(data = df_combined()) +
        aes(x = !!input$scatter_x_var,
            y = !!input$scatter_y_var) +
        geom_point(shape = 21,
                   colour = '#000000',
                   fill = '#000000',
                   alpha = input$scatter_alpha,
                   size = input$scatter_size) +
        geom_point(shape = 21,
                   colour = '#000000',
                   size = input$scatter_size) +
        labs(title = input$scatter_title,
             y = input$scatter_y_label,
             x = input$scatter_x_label) +
        scale_x_continuous(limits = c(input$scatter_min_x, input$scatter_max_x)) +
        scale_y_continuous(limits = c(input$scatter_min_y, input$scatter_max_y)) +
        theme_minimal(base_size = input$scatter_base_size) +
        theme(plot.background = element_rect(colour = '#FFFFFF',
                                             fill = '#FFFFFF'),
              plot.title = element_text(size = input$scatter_base_size),
              axis.text = element_text(colour = '#000000'),
              axis.line = element_line(colour = '#000000',
                                       size = 0.5),
              axis.ticks = element_line(colour = '#000000',
                                        size = 0.5),
              panel.grid = element_blank())
        
    } else if(input$scatter_smooth == 'linear' & input$scatter_group_var == 'None'){
        
        ggplot(data = df_combined()) +
        aes(x = !!input$scatter_x_var,
            y = !!input$scatter_y_var) +
        geom_point(shape = 21,
                   colour = '#000000',
                   fill = '#000000',
                   alpha = input$scatter_alpha,
                   size = input$scatter_size) +
        geom_point(shape = 21,
                   colour = '#000000',
                   size = input$scatter_size) +
        geom_smooth(method = 'lm',
                    colour = '#000000',
                    size = 1,
                    se = FALSE) +
        labs(title = input$scatter_title,
             y = input$scatter_y_label,
             x = input$scatter_x_label) +
        scale_x_continuous(limits = c(input$scatter_min_x, input$scatter_max_x)) +
        scale_y_continuous(limits = c(input$scatter_min_y, input$scatter_max_y)) +
        theme_minimal(base_size = input$scatter_base_size) +
        theme(plot.background = element_rect(colour = '#FFFFFF',
                                             fill = '#FFFFFF'),
              plot.title = element_text(size = input$scatter_base_size),
              axis.text = element_text(colour = '#000000'),
              axis.line = element_line(colour = '#000000',
                                       size = 0.5),
              axis.ticks = element_line(colour = '#000000',
                                        size = 0.5),
              panel.grid = element_blank())
        
    } else if(input$scatter_smooth == 'loess' & input$scatter_group_var == 'None'){
        
        ggplot(data = df_combined()) +
        aes(x = !!input$scatter_x_var,
            y = !!input$scatter_y_var) +
        geom_point(shape = 21,
                   colour = '#000000',
                   fill = '#000000',
                   alpha = input$scatter_alpha,
                   size = input$scatter_size) +
        geom_point(shape = 21,
                   colour = '#000000',
                   size = input$scatter_size) +
        geom_smooth(method = 'loess',
                    colour = '#000000',
                    size = 1,
                    se = FALSE) +
        labs(title = input$scatter_title,
             y = input$scatter_y_label,
             x = input$scatter_x_label) +
        scale_x_continuous(limits = c(input$scatter_min_x, input$scatter_max_x)) +
        scale_y_continuous(limits = c(input$scatter_min_y, input$scatter_max_y)) +
        theme_minimal(base_size = input$scatter_base_size) +
        theme(plot.background = element_rect(colour = '#FFFFFF',
                                                 fill = '#FFFFFF'),
              plot.title = element_text(size = input$scatter_base_size),
              axis.text = element_text(colour = '#000000'),
              axis.line = element_line(colour = '#000000',
                                       size = 0.5),
              axis.ticks = element_line(colour = '#000000',
                                        size = 0.5),
              panel.grid = element_blank())
        
    } else if(input$scatter_smooth == 'linear' & input$scatter_group_var != 'None'){
        
        if(input$scatter_legend_position != 'legend_user'){
            
            ggplot(data = df_combined()) +
                aes(x = !!input$scatter_x_var,
                    y = !!input$scatter_y_var,
                    fill = df_combined()[[input$scatter_group_var]],
                    colour = df_combined()[[input$scatter_group_var]]) +
                geom_point(shape = 21,
                           alpha = input$scatter_alpha,
                           size = input$scatter_size) +
                geom_point(shape = 21,
                           fill = NA,
                           size = input$scatter_size) +
                geom_smooth(method = 'lm',
                            size = 1,
                            se = FALSE) +
                labs(title = input$scatter_title,
                     y = input$scatter_y_label,
                     x = input$scatter_x_label) +
                scale_x_continuous(limits = c(input$scatter_min_x, input$scatter_max_x)) +
                scale_y_continuous(limits = c(input$scatter_min_y, input$scatter_max_y)) +
                scale_colour_tableau(palette = input$scatter_colours,
                                     na.translate = FALSE) +
                scale_fill_tableau(palette = input$scatter_colours,
                                   na.translate = FALSE) +
                theme_minimal(base_size = input$scatter_base_size) +
                theme(plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$scatter_base_size),
                      legend.position = input$scatter_legend_position,
                      legend.title = element_blank(),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        } else if(input$scatter_legend_position == 'legend_user'){
            
            ggplot(data = df_combined()) +
                aes(x = !!input$scatter_x_var,
                    y = !!input$scatter_y_var,
                    fill = df_combined()[[input$scatter_group_var]],
                    colour = df_combined()[[input$scatter_group_var]]) +
                geom_point(shape = 21,
                           alpha = input$scatter_alpha,
                           size = input$scatter_size) +
                geom_point(shape = 21,
                           fill = NA,
                           size = input$scatter_size) +
                geom_smooth(method = 'lm',
                            size = 1,
                            se = FALSE) +
                labs(title = input$scatter_title,
                     y = input$scatter_y_label,
                     x = input$scatter_x_label) +
                scale_x_continuous(limits = c(input$scatter_min_x, input$scatter_max_x)) +
                scale_y_continuous(limits = c(input$scatter_min_y, input$scatter_max_y)) +
                scale_colour_tableau(palette = input$scatter_colours,
                                     na.translate = FALSE) +
                scale_fill_tableau(palette = input$scatter_colours,
                                   na.translate = FALSE) +
                theme_minimal(base_size = input$scatter_base_size) +
                theme(plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$scatter_base_size),
                      legend.position = c(input$scatter_x_legend, input$scatter_y_legend),
                      legend.title = element_blank(),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        }
        
    } else if(input$scatter_smooth == 'loess' & input$scatter_group_var != 'None'){
        
        if(input$scatter_legend_position != 'legend_user'){
            
            ggplot(data = df_combined()) +
                aes(x = !!input$scatter_x_var,
                    y = !!input$scatter_y_var,
                    fill = df_combined()[[input$scatter_group_var]],
                    colour = df_combined()[[input$scatter_group_var]]) +
                geom_point(shape = 21,
                           alpha = input$scatter_alpha,
                           size = input$scatter_size) +
                geom_point(shape = 21,
                           fill = NA,
                           size = input$scatter_size) +
                geom_smooth(method = 'loess',
                            size = 1,
                            se = FALSE) +
                labs(title = input$scatter_title,
                     y = input$scatter_y_label,
                     x = input$scatter_x_label) +
                scale_x_continuous(limits = c(input$scatter_min_x, input$scatter_max_x)) +
                scale_y_continuous(limits = c(input$scatter_min_y, input$scatter_max_y)) +
                scale_colour_tableau(palette = input$scatter_colours,
                                     na.translate = FALSE) +
                scale_fill_tableau(palette = input$scatter_colours,
                                   na.translate = FALSE) +
                theme_minimal(base_size = input$scatter_base_size) +
                theme(plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$scatter_base_size),
                      legend.position = input$scatter_legend_position,
                      legend.title = element_blank(),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        } else if(input$scatter_legend_position == 'legend_user'){
            
            ggplot(data = df_combined()) +
                aes(x = !!input$scatter_x_var,
                    y = !!input$scatter_y_var,
                    fill = df_combined()[[input$scatter_group_var]],
                    colour = df_combined()[[input$scatter_group_var]]) +
                geom_point(shape = 21,
                           alpha = input$scatter_alpha,
                           size = input$scatter_size) +
                geom_point(shape = 21,
                           fill = NA,
                           size = input$scatter_size) +
                geom_smooth(method = 'loess',
                            size = 1,
                            se = FALSE) +
                labs(title = input$scatter_title,
                     y = input$scatter_y_label,
                     x = input$scatter_x_label) +
                scale_x_continuous(limits = c(input$scatter_min_x, input$scatter_max_x)) +
                scale_y_continuous(limits = c(input$scatter_min_y, input$scatter_max_y)) +
                scale_colour_tableau(palette = input$scatter_colours,
                                     na.translate = FALSE) +
                scale_fill_tableau(palette = input$scatter_colours,
                                   na.translate = FALSE) +
                theme_minimal(base_size = input$scatter_base_size) +
                theme(plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$scatter_base_size),
                      legend.position = c(input$scatter_x_legend, input$scatter_y_legend),
                      legend.title = element_blank(),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        }
        
    } else {
        
        if(input$scatter_legend_position != 'legend_user'){
            
            ggplot(data = df_combined()) +
                aes(x = !!input$scatter_x_var,
                    y = !!input$scatter_y_var,
                    fill = df_combined()[[input$scatter_group_var]],
                    colour = df_combined()[[input$scatter_group_var]]) +
                geom_point(shape = 21,
                           alpha = input$scatter_alpha,
                           size = input$scatter_size) +
                geom_point(shape = 21,
                           fill = NA,
                           size = input$scatter_size) +
                labs(title = input$scatter_title,
                     y = input$scatter_y_label,
                     x = input$scatter_x_label) +
                scale_x_continuous(limits = c(input$scatter_min_x, input$scatter_max_x)) +
                scale_y_continuous(limits = c(input$scatter_min_y, input$scatter_max_y)) +
                scale_colour_tableau(palette = input$scatter_colours,
                                     na.translate = FALSE) +
                scale_fill_tableau(palette = input$scatter_colours,
                                   na.translate = FALSE) +
                theme_minimal(base_size = input$scatter_base_size) +
                theme(plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$scatter_base_size),
                      legend.position = input$scatter_legend_position,
                      legend.title = element_blank(),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        } else if(input$scatter_legend_position == 'legend_user'){
            
            ggplot(data = df_combined()) +
                aes(x = !!input$scatter_x_var,
                    y = !!input$scatter_y_var,
                    fill = df_combined()[[input$scatter_group_var]],
                    colour = df_combined()[[input$scatter_group_var]]) +
                geom_point(shape = 21,
                           alpha = input$scatter_alpha,
                           size = input$scatter_size) +
                geom_point(shape = 21,
                           fill = NA,
                           size = input$scatter_size) +
                labs(title = input$scatter_title,
                     y = input$scatter_y_label,
                     x = input$scatter_x_label) +
                scale_x_continuous(limits = c(input$scatter_min_x, input$scatter_max_x)) +
                scale_y_continuous(limits = c(input$scatter_min_y, input$scatter_max_y)) +
                scale_colour_tableau(palette = input$scatter_colours,
                                     na.translate = FALSE) +
                scale_fill_tableau(palette = input$scatter_colours,
                                   na.translate = FALSE) +
                theme_minimal(base_size = input$scatter_base_size) +
                theme(plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$scatter_base_size),
                      legend.position = c(input$scatter_x_legend, input$scatter_y_legend),
                      legend.title = element_blank(),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        }
    }
)

plotOutput('scatter_plot')
```

```{r scatter_3}
# Download plot
output$scatterplot_download_button <- downloadHandler(
    filename = function() {
        paste0('scatterplot_', Sys.Date(), '.', input$scatter_format)
    },
    content = function(file) {
        plotOutput('scatter_plot')
        ggsave(file, 
               width = input$scatter_width, 
               height = input$scatter_height,
               units = 'cm')
    }
  )
```

Histogram {data-navmenu='Select a plot type'}
=====================================  

Column {.sidebar data-width=350}
-------------------------------------

```{r histogram_1}
h1('Histogram')

p(strong('Remember to upload your data first.'))

p('For download options, scroll to the bottom of this sidebar.')

hr()

# Select variables
## Response variable
output$histo_var <- renderUI({
    req(df_numeric())
    varSelectInput(inputId = 'histo_var',
                   label = 'Choose variable to be plotted',
                   data = df_numeric())
    })

uiOutput('histo_var')

## Add labels
textInput(inputId = 'histo_title', 
          label = 'Plot title',
          value = NULL)

textInput(inputId = 'histo_y_label', 
          label = 'Y-axis label',
          value = 'Count')

textInput(inputId = 'histo_x_label', 
          label = 'X-axis label',
          value = NULL)

## Base font size
sliderInput(inputId = 'histo_base_size',
            label = 'Font size',
            value = 18,
            min = 8,
            max = 28)

## Bin width
numericInput(inputId = 'histo_bin_width',
             label = 'Bin width',
             value = 1,
             min = 0.00000000001)

## Bar transparency size
sliderInput(inputId = 'histo_alpha',
            label = 'Bar transparency',
            value = 0.6,
            min = 0,
            max = 1)

hr()

h1('Download plot')

# Format
selectInput(inputId = 'histo_format',
            label = 'Choose file format',
            selected = 'png',
            choices = c('bmp', 'jpg', 'pdf', 'png'))

# Plot width
numericInput(inputId = 'histo_width',
             label = 'Figure width (cm)',
             value = 18)

## Plot height
numericInput(inputId = 'histo_height',
             label = 'Figure height (cm)',
             value = 13)

# Add download button
output$histo_download_button <- renderUI({
    downloadButton(outputId = 'histogram_download_button',
                   label = "'Click' to download image")
    })

uiOutput('histo_download_button')
```

Column
-------------------------------------

### Plot

```{r histogram_2}
# Plot graph
output$histo_plot <- renderPlot(
    
        ggplot(data = df_numeric()) +
        aes(!!input$histo_var) +
        geom_histogram(binwidth = input$histo_bin_width,
                       fill = '#000000',
                       colour = '#000000',
                       alpha = input$histo_alpha) +
        labs(title = input$histo_title,
             y = input$histo_y_label,
             x = input$histo_x_label) +
        theme_minimal(base_size = input$histo_base_size) +
            theme(plot.background = element_rect(colour = '#FFFFFF',
                                                 fill = '#FFFFFF'),
                  plot.title = element_text(size = input$histo_base_size),
                  axis.text = element_text(colour = '#000000'),
                  axis.line = element_line(colour = '#000000',
                                           size = 0.5),
                  axis.ticks = element_line(colour = '#000000',
                                            size = 0.5),
                  panel.grid = element_blank())
        
        )

plotOutput('histo_plot')
```

```{r histogram_3}
# Download plot
output$histogram_download_button <- downloadHandler(
    filename = function() {
        paste0('histogram_', Sys.Date(), '.', input$histo_format)
    },
    content = function(file) {
        plotOutput('histo_plot')
        ggsave(file, 
               width = input$histo_width, 
               height = input$histo_height,
               units = 'cm')
    }
  )
```

Bar chart {data-navmenu='Select a plot type'}
=====================================  

Column {.sidebar data-width=350}
-------------------------------------

```{r column_1}
h1('Bar chart')

p(strong('Remember to upload your data first.'))

p('For download options, scroll to the bottom of this sidebar.')

hr()

# Select variables
## Choose column to plot
output$bar_column <- renderUI({
    req(df_categorical())
    varSelectInput(inputId = 'bar_column_plot',
                   label = 'Select variables to plot',
                   selected = NULL,
                   multiple = FALSE,
                   data = df_categorical())
})

uiOutput('bar_column')

## Choose grouping column
output$bar_group <- renderUI({
    req(df_categorical())
    selectInput(inputId = 'bar_column_group',
                label = 'Select grouping variable (optional)',
                selected = 'None',
                choices = c('None', names(df_categorical())))
})

uiOutput('bar_group')

## Add labels
textInput(inputId = 'bar_title', 
          label = 'Plot title',
          value = NULL)

textInput(inputId = 'bar_y_label', 
          label = 'Y-axis label',
          value = NULL)

textInput(inputId = 'bar_x_label', 
          label = 'X-axis label',
          value = NULL)

## Base font size
sliderInput(inputId = 'bar_base_size',
            label = 'Font size',
            value = 18,
            min = 8,
            max = 28)

## Point transparency size
sliderInput(inputId = 'bar_alpha',
            label = 'Bar transparency',
            value = 1,
            min = 0,
            max = 1)

## Y-axis limits
numericInput(inputId = 'bar_min_y',
             label = 'Minimum y-axis value',
             value = NULL)

numericInput(inputId = 'bar_max_y',
             label = 'Maximum y-axis value',
             value = NULL)

hr()

strong('Options for the grouping variable')

## Remove NA values
radioButtons(inputId = 'bar_na',
             label = 'Grouping variable missing values',
             choices = c('Keep (default)' = 'keep',
                         'Remove' = 'remove'),
             selected = 'keep')

## Choose plot type
radioButtons(inputId = 'bar_plot_type',
             label = 'Plot options',
             choices = c('Side-by-side bars (default)' = 'bar_side',
                         'Stacked bars' = 'bar_stacked',
                         'Proportions' = 'bar_prop'),
             selected = 'bar_side')

## Colour scheme
selectInput(inputId = 'bar_colours',
            label = 'Colour scheme',
            selected = NULL,
            choices = c('Default (20 colours)' = 'Tableau 20',
                        'Tableau (10 colours)' = 'Tableau 10',
                        'Colour blind (10 colours)' = 'Color Blind',
                        'Grey (5 colours)' = 'Classic Gray 5'))

## Legend position
radioButtons(inputId = 'bar_legend_position',
             label = 'Legend position',
             choices = c('None (default)' = 'none',
                         'Right side of plot' = 'right',
                         'Above the plot' = 'top',
                         'User-defined' = 'legend_user'),
             selected = 'none')

### x value
sliderInput(inputId = 'bar_x_legend',
            label = 'User-defined legend position (x coordinate)',
            value = 0.85,
            min = 0,
            max = 1)

### y-value
sliderInput(inputId = 'bar_y_legend',
            label = 'User-defined legend position (y coordinate)',
            value = 0.85,
            min = 0,
            max = 1)

hr()

h1('Download plot')

# Format
selectInput(inputId = 'bar_format',
            label = 'Choose file format',
            selected = 'png',
            choices = c('bmp', 'jpg', 'pdf', 'png'))

# Plot width
numericInput(inputId = 'bar_width',
             label = 'Figure width (cm)',
             value = 17)

## Plot height
numericInput(inputId = 'bar_height',
             label = 'Figure height (cm)',
             value = 14)

# Add download button
output$bar_download_button <- renderUI({
    downloadButton(outputId = 'barplot_download_button',
                   label = "'Click' to download image")
    })

uiOutput('bar_download_button')
```

Column
-------------------------------------

### Plot

```{r column_2}
# Silently remove NA values
df_categorical2 <- reactive({
    df_categorical() %>% 
        drop_na(!!input$bar_column_plot, input$bar_column_group)
    })

# Plot graph
output$bar_plot <- renderPlot(
    
    if(!is.null(req(input$bar_column_plot)) & req(input$bar_column_group) == 'None'){
        
        ggplot(data = df_categorical()) +
            aes(x = !!input$bar_column_plot) +
            geom_bar(colour = '#000000',
                     fill = '#000000',
                     alpha = input$bar_alpha) +
            geom_bar(colour = '#000000',
                     fill = NA) +
            labs(title = input$bar_title,
                 y = input$bar_y_label,
                 x = input$bar_x_label) +
            scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
            scale_x_discrete(na.translate = FALSE) +
            theme_minimal(base_size = input$bar_base_size) +
            theme(plot.background = element_rect(colour = '#FFFFFF',
                                                 fill = '#FFFFFF'),
                  plot.title = element_text(size = input$bar_base_size),
                  axis.text = element_text(colour = '#000000'),
                  axis.line = element_line(colour = '#000000',
                                           size = 0.5),
                  axis.ticks = element_line(colour = '#000000',
                                            size = 0.5),
                  panel.grid = element_blank())
        
    } else if(input$bar_plot_type == 'bar_side' & input$bar_column_group != 'None' & input$bar_na == 'remove'){
        
        if(input$bar_legend_position != 'legend_user'){
            
            ggplot(data = df_categorical2()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical2()[[input$bar_column_group]],
                    colour = df_categorical2()[[input$bar_column_group]]) +
                geom_bar(position = position_dodge(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_dodge(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours) +
                scale_colour_tableau(palette = input$bar_colours) +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = input$bar_legend_position,
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        } else if(input$bar_legend_position == 'legend_user'){
            
            ggplot(data = df_categorical2()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical2()[[input$bar_column_group]],
                    colour = df_categorical2()[[input$bar_column_group]]) +
                geom_bar(position = position_dodge(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_dodge(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours) +
                scale_colour_tableau(palette = input$bar_colours) +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = c(input$bar_x_legend, input$bar_y_legend),
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        }
        
    } else if(input$bar_plot_type == 'bar_stacked' & input$bar_column_group != 'None' & input$bar_na == 'remove'){
        
        if(input$bar_legend_position != 'legend_user'){
            
            ggplot(data = df_categorical2()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical2()[[input$bar_column_group]],
                    colour = df_categorical2()[[input$bar_column_group]]) +
                geom_bar(position = position_stack(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_stack(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours) +
                scale_colour_tableau(palette = input$bar_colours) +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = input$bar_legend_position,
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        } else if(input$bar_legend_position == 'legend_user'){
            
            ggplot(data = df_categorical2()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical2()[[input$bar_column_group]],
                    colour = df_categorical2()[[input$bar_column_group]]) +
                geom_bar(position = position_stack(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_stack(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours) +
                scale_colour_tableau(palette = input$bar_colours) +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = c(input$bar_x_legend, input$bar_y_legend),
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        }
        
    } else if(input$bar_plot_type == 'bar_prop' & input$bar_column_group != 'None' & input$bar_na == 'remove'){
        
        if(input$bar_legend_position != 'legend_user'){
            
            ggplot(data = df_categorical2()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical2()[[input$bar_column_group]],
                    colour = df_categorical2()[[input$bar_column_group]]) +
                geom_bar(position = position_fill(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_fill(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours) +
                scale_colour_tableau(palette = input$bar_colours) +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = input$bar_legend_position,
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        } else if(input$bar_legend_position == 'legend_user'){
            
            ggplot(data = df_categorical2()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical2()[[input$bar_column_group]],
                    colour = df_categorical2()[[input$bar_column_group]]) +
                geom_bar(position = position_fill(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_fill(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours) +
                scale_colour_tableau(palette = input$bar_colours) +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = c(input$bar_x_legend, input$bar_y_legend),
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        }
    } else if(input$bar_plot_type == 'bar_side' & input$bar_column_group != 'None' & input$bar_na == 'keep'){
        
        if(input$bar_legend_position != 'legend_user'){
            
            ggplot(data = df_categorical()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical()[[input$bar_column_group]],
                    colour = df_categorical()[[input$bar_column_group]]) +
                geom_bar(position = position_dodge(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_dodge(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours,
                                   na.value = '#999999') +
                scale_colour_tableau(palette = input$bar_colours,
                                     na.value = '#999999') +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = input$bar_legend_position,
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        } else if(input$bar_legend_position == 'legend_user'){
            
            ggplot(data = df_categorical()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical()[[input$bar_column_group]],
                    colour = df_categorical()[[input$bar_column_group]]) +
                geom_bar(position = position_dodge(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_dodge(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours,
                                   na.value = '#999999') +
                scale_colour_tableau(palette = input$bar_colours,
                                     na.value = '#999999') +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = c(input$bar_x_legend, input$bar_y_legend),
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        }
        
    } else if(input$bar_plot_type == 'bar_stacked' & input$bar_column_group != 'None' & input$bar_na == 'keep'){
        
        if(input$bar_legend_position != 'legend_user'){
            
            ggplot(data = df_categorical()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical()[[input$bar_column_group]],
                    colour = df_categorical()[[input$bar_column_group]]) +
                geom_bar(position = position_stack(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_stack(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours,
                                   na.value = '#999999') +
                scale_colour_tableau(palette = input$bar_colours,
                                     na.value = '#999999') +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = input$bar_legend_position,
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        } else if(input$bar_legend_position == 'legend_user'){
            
            ggplot(data = df_categorical()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical()[[input$bar_column_group]],
                    colour = df_categorical()[[input$bar_column_group]]) +
                geom_bar(position = position_stack(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_stack(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours,
                                   na.value = '#999999') +
                scale_colour_tableau(palette = input$bar_colours,
                                     na.value = '#999999') +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = c(input$bar_x_legend, input$bar_y_legend),
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        }
        
    } else if(input$bar_plot_type == 'bar_prop' & input$bar_column_group != 'None' & input$bar_na == 'keep'){
        
        if(input$bar_legend_position != 'legend_user'){
            
            ggplot(data = df_categorical()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical()[[input$bar_column_group]],
                    colour = df_categorical()[[input$bar_column_group]]) +
                geom_bar(position = position_fill(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_fill(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours,
                                   na.value = '#999999') +
                scale_colour_tableau(palette = input$bar_colours,
                                     na.value = '#999999') +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = input$bar_legend_position,
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        } else if(input$bar_legend_position == 'legend_user'){
            
            ggplot(data = df_categorical()) +
                aes(x = !!input$bar_column_plot,
                    fill = df_categorical()[[input$bar_column_group]],
                    colour = df_categorical()[[input$bar_column_group]]) +
                geom_bar(position = position_fill(),
                         alpha = input$bar_alpha) +
                geom_bar(position = position_fill(),
                         fill = NA) +
                labs(title = input$bar_title,
                     y = input$bar_y_label,
                     x = input$bar_x_label) +
                scale_y_continuous(limits = c(input$bar_min_y, input$bar_max_y)) +
                scale_fill_tableau(palette = input$bar_colours,
                                   na.value = '#999999') +
                scale_colour_tableau(palette = input$bar_colours,
                                     na.value = '#999999') +
                theme_minimal(base_size = input$bar_base_size) +
                theme(legend.position = c(input$bar_x_legend, input$bar_y_legend),
                      legend.title = element_blank(),
                      plot.background = element_rect(colour = '#FFFFFF',
                                                     fill = '#FFFFFF'),
                      plot.title = element_text(size = input$bar_base_size),
                      axis.text = element_text(colour = '#000000'),
                      axis.line = element_line(colour = '#000000',
                                               size = 0.5),
                      axis.ticks = element_line(colour = '#000000',
                                                size = 0.5),
                      panel.grid = element_blank())
            
        }
    }
)

plotOutput('bar_plot')
```

```{r column_3}
# Download plot
output$barplot_download_button <- downloadHandler(
    filename = function() {
        paste0('barcharts_', Sys.Date(), '.', input$bar_format)
    },
    content = function(file) {
        plotOutput('bar_plot')
        ggsave(file, 
               width = input$bar_width, 
               height = input$bar_height,
               units = 'cm')
    }
  )
```
